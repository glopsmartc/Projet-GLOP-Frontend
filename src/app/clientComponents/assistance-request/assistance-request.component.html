<div class="assistance-request mt-4">
  <div *ngIf="!submitted">
    <h1>Soumettre une demande d‚Äôassistance</h1>
    <p class="mb-5">Remplissez ce formulaire pour nous informer de votre probl√®me. Nous traiterons votre demande rapidement.</p>
  </div>

<!-- Step 0: Contract Selection -->
<div class="mb-5" *ngIf="step === 0">
  <div *ngIf="contractErrorMsg" class="error-message">
    {{ contractErrorMsg }}
  </div>
  <h2 *ngIf="!contractErrorMsg">S√©lectionnez un contrat actif</h2>
  <div *ngIf="hasActiveContracts()">
    <select [(ngModel)]="selectedContract" (change)="onContractSelect(selectedContract?.id)">
      <option [ngValue]="null">S√©lectionnez un contrat</option>
      <option *ngFor="let contract of activeContracts" [ngValue]="contract"> {{ contract.name }} ({{ contract.id }})</option>
    </select>
  </div>
</div>

<!-- Step 1: Type of Assistance -->
<div class="mb-5" *ngIf="step === 1">
  <h2>Type d‚Äôassistance</h2>
  <select [(ngModel)]="assistanceType" style="display: inline-block;">
    <option value="">S√©lectionnez le type d‚Äôassistance</option>
    <option *ngFor="let service of services" [value]="service">{{ service }}</option>
  </select>

  <div *ngIf="assistanceType === 'Conseils m√©dicaux' || assistanceType === 'Pris en charge des frais m√©dicaux' || assistanceType === 'Orientation vers des h√¥pitaux r√©f√©renc√©s'">
    <h2 class="mt-3">Avez-vous des maladies chroniques ?</h2>
    <label>
      <input type="radio" [(ngModel)]="maladieChronique" name="maladieChronique" [value]="true"> Oui
    </label>
    <label>
      <input type="radio" [(ngModel)]="maladieChronique" name="maladieChronique" [value]="false"> Non
    </label>
  </div>

   <div *ngIf="maladieChronique">
  <h2>Maladies chroniques :</h2>
  <textarea [(ngModel)]="descriptionMaladie" placeholder="D√©crivez vos maladies chroniques"></textarea>
</div>

    <h2 class="mt-3">Urgence</h2>
    <label>
      <input type="radio" [(ngModel)]="urgency" name="urgency" value="Urgent"> Urgent
    </label>
    <label>
      <input type="radio" [(ngModel)]="urgency" name="urgency" value="Non-urgent"> Non urgent
    </label>

    <h2>D√©scription</h2>
    <textarea [(ngModel)]="description" placeholder="D√©crivez votre probl√®me en d√©tail"></textarea>

    <h2>Joindre les documents</h2>
    <p>Veuillez t√©l√©charger les PDFs ou images relatifs √† votre demande.</p>
    <p><strong>Note :</strong> Si votre demande concerne un <strong>accident</strong>, veuillez √©galement joindre le <strong>constat amiable</strong>. Vous pouvez t√©l√©charger un mod√®le de constat amiable en cliquant <a href="/constat-amiable" target="_blank">ici</a>.</p>

    <!-- Section fichiers -->
    <div class="file-uploads">
      <input type="file" (change)="onFileUpload($event)" accept="application/pdf,image/*" multiple>

      <div *ngIf="pdfFiles.length > 0 || imageFiles.length > 0" class="mt-3"> </div>

      <!-- Liste des PDFs -->
      <div *ngFor="let pdf of pdfFiles; let i = index" class="pdf-item">
        <span>{{ pdf.name }}</span>&nbsp;
        <u style="color: green; cursor: pointer;"><a (click)="togglePdfDisplay(i)">
            {{ showPdf[i] ? 'Masquer' : 'Afficher' }}</a></u>&nbsp;
        <u style="color: green; cursor: pointer;"><a (click)="removePdf(i)">Supprimer</a></u>
        <div>
          <object *ngIf="showPdf[i]" [data]="pdf.preview" type="application/pdf" width="50%" height="420px">
            <p>Le document PDF "{{pdf.name}}" ne peut pas √™tre affich√©. Veuillez t√©l√©charger le fichier pour le
              visualiser.</p>
          </object>
        </div>
      </div>

      <!-- Liste des images -->
      <div *ngFor="let image of imageFiles; let i = index" class="image-item">
        <span>{{ image.name }}</span>&nbsp;
        <u style="color: green; cursor: pointer;"><a (click)="toggleImageDisplay(i)">
            {{ showImage[i] ? 'Masquer' : 'Afficher' }}</a></u>&nbsp;
        <u style="color: green; cursor: pointer;"><a (click)="removeImage(i)">Supprimer</a></u>
        <div>
          <img *ngIf="showImage[i]" [src]="image.preview" alt="Preview" width="50%">
        </div>
      </div>
    </div>


  </div>

  <!-- Step 2: Location -->
  <div class="mb-5" *ngIf="step === 2">
    <div class="location-section">
      <h2>Localisation</h2>

      <div *ngIf="isLocating" class="loading">
        R√©cup√©ration de ma position...
      </div>

      <div *ngIf="locationError" class="error">
        {{ locationError }}
      </div>

      <div *ngIf="location" class="location-info">
        <p>üìç {{ location }}</p>
      </div>

      <button (click)="getLocation()" [disabled]="isLocating" class="location-button bg-transparent"
        style="color: green;"> Obtenir ma position </button>

      <div class="manual-input">
        <input type="text" [(ngModel)]="manualLocation" placeholder="O√π avez-vous besoin d‚Äôassistance ?">
      </div>
    </div>
  </div>

  <!-- Step 4: Contact Information -->
  <div class="mb-5" *ngIf="step === 3">
    <h2>Informations de contact</h2>
    <input type="tel" placeholder="Tel (+33)" [(ngModel)]="phone" name="phone" required />
    <input type="email" [(ngModel)]="email" placeholder="Email" required>
  </div>

  <!-- Navigation Buttons -->
  <div class="navigation">
    <div *ngIf="emptyFieldError" class="error-message">{{ errorMessage }}</div>
    <button *ngIf="step > 0 && step < 4" (click)="previousStep()">Pr√©c√©dent</button>
    <button *ngIf="step < 3 && !contractErrorMsg" (click)="nextStep()">Suivant</button>
    <button *ngIf="step === 3" (click)="validateAndSubmit()">Soumettre</button>
  </div>
</div>

<!-- Confirmation Screen -->
<div *ngIf="submitted && step === 4" class="confirmation">
  <h1 class="mb-4">Votre demande a √©t√© soumise avec succ√®s !</h1>
  <p><strong>Type d‚Äôassistance:</strong> {{ assistanceType }}<span *ngIf="assistanceType === 'Autre'"> : {{
      otherType }}</span></p>
  <p *ngIf="maladieChronique === true"><strong>Informations m√©dicales:</strong> {{
   description }} </p>
  <p><strong>Description:</strong> {{ description }}</p>
  <p><strong>Urgence:</strong> {{ urgency }}</p>
  <p><strong>Localisation:</strong> {{ location }}</p>
  <p><strong>Num√©ro de T√©l√©phone:</strong> {{ phone }}</p>
  <p><strong>Email:</strong> {{ email }}</p>
  <p class="mt-3">Notre √©quipe vous contactera sous peu. Merci de votre patience.</p>
  <button class="mb-5" (click)="goHome()">Retour √† l‚Äôaccueil</button>
</div>
